{% extends 'layout.html' %}
{% block content %}

{% if message %}
<div id="message" class="alert alert-success fixed-bottom m-0" role="alert">
    {{ message }}
    <button class="close" onclick="closeMessage()">
        <span aria-hidden="true">&times;</span>
    </button>
</div>
{% endif %}

<div id="container" class="container">
    <div class="row justify-content-around fixed-top py-4" style="margin-top: 60px; background-color: rgba(255, 255, 255, 0.8);">
        <div class="col-5 align-self-center">
            <a class="btn btn-outline-primary w-100" href="/memory/create">思い出を投稿する</a>
        </div>
    </div>
    <div class="row justify-content-around" style="margin-top: 86px;">
        <div v-for="memory in memories" class="frame mb-4" style="width: 250px;">
                <img :id="memory.id" style="width: 100%; height: 250px; object-fit: cover;">
        </div>
    </div>
</div>

<script>
    function closeMessage() {
        $('#message').fadeOut('fast', () => $(this).remove());
    }
    function checkDelete() {
        if (window.confirm("本当に削除してもよろしいですか？")) return true;
        else return false;
    }
    function showImage(id) {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `/api/memory/${id}/image`, true);
        xhr.responseType = 'arraybuffer';
        xhr.onload = function() {
            const blob = new Blob([this.response], {type: 'image/*'});
            const url = window.URL || window.webkitURL;
            const img = document.getElementById(id);
            img.src = url.createObjectURL(blob);
        }
        xhr.send();
    }
    new Vue({
        el: '#container',
        data: {
            user: {},
            target: {},
            memories: []
        },
        methods: {
        },
        mounted: function() {
            $.ajax({
                url: '/api/memories',
                dataType: 'json'
            })
            .then(
                memories => {
                    this.memories = memories;
                    memories.forEach((memory) => showImage(memory.id));
                },
                error => console.error(error)
            );
            $.ajax({
                url: '/api/user',
                dataType: 'json'
            })
            .then(
                user => this.user = user,
                error => console.error(error)
            );
        },
        delimiters: ['[[', ']]']
    })
</script>

{% endblock %}
